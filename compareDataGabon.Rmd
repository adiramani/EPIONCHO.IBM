---
title: "Comparing Simulations to Actual Data - Gabon Case Study"
author: "Aditya Ramani"
date: "2023-06-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(7281998)
library(dplyr)
library(ggplot2)
library(tidyr)
library(fastR2)
library(stringr)
knitr::knit_hooks$set(timeit = local({
  now = NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res = difftime(Sys.time(), now)
      now <<- NULL
      # use options$label if you want the chunk label as well
      paste('Time for this code chunk:', as.character(res))
    }
  }})
)
```

## Simulation Data

```{r simulation_processing_functions}
processRCSFiles <- function (files='ov16_gabon_4/', verbose=TRUE, onlyCalcMFP=FALSE) {
  allOutputs <- data.frame()
  fileToUse <- paste("data/", files, sep="")

  i <- 1
  mda_vals <- c()
  abr_vals <- c()
  mf_prev_vals <- c()
  total_files <- length(list.files(fileToUse))
  for (file in list.files(fileToUse)) {
    if(verbose) {
      print(i)
    }
    tryCatch(
    {
      tmpRDSData <- readRDS(paste(fileToUse, file,sep=""))
    },
    error = function(e) {
      message(paste("Error occurred while reading:", fileToUse))
    }
    )
    
    mf_prev_vals <- c(mf_prev_vals, tail(tmpRDSData$mf_prev)[1])
    mda_vals <- c(mda_vals, tmpRDSData$MDA)
    abr_vals <- c(abr_vals, tmpRDSData$ABR)
    if(onlyCalcMFP) {
      next
    }
    
    age <- tmpRDSData$ov16_seropositive_matrix[,1]
    sex <- ifelse(tmpRDSData$ov16_seropositive_matrix[,2] == 1, "Male", "Female")
    mf_prev <- tmpRDSData$ov16_seropositive_matrix[,3]
    ov16_seropos <- tmpRDSData$ov16_seropositive_matrix[,4]
    ov_l3 <- tmpRDSData$ov16_seropositive_matrix[,5]
    ov_l4 <- tmpRDSData$ov16_seropositive_matrix[,6]
    ov_mating_no_mf <- tmpRDSData$ov16_seropositive_matrix[,7]
    ov_mating_detectable_mf <- tmpRDSData$ov16_seropositive_matrix[,8]
    ov_mating_any_mf <- tmpRDSData$ov16_seropositive_matrix[,9]

    tmpNumRows <- length(age)
    if(i == 1) {
      allOutputs <- data.frame(matrix(ncol=11, nrow=tmpNumRows*total_files))
      colnames(allOutputs) <- c("age", "sex", "ov16_pos", "ov16_pos_l3", "ov16_pos_l4", "ov16_pos_mating_no_mf", "ov16_pos_mating_detectable_mf", "ov16_pos_mating_any_mf", "mf_prev", "ABR", "run_num")
    }

    startIndex <- 1+tmpNumRows*(i-1)
    endIndex <- tmpNumRows*i
    allOutputs[startIndex:endIndex,-11] <- list(age, sex, ov16_seropos, ov_l3, ov_l4, ov_mating_no_mf, ov_mating_detectable_mf, ov_mating_any_mf, mf_prev, tmpRDSData$ABR)
    allOutputs[startIndex:endIndex,11] <- i

    i <- i + 1
  }

  print(paste("Overall Pre Treatment MF Prevalence:", mean(mf_prev_vals)))
  print(paste("Avg MDA Years:", mean(mda_vals)))
  # par(mfrow=c(2,1))
  # freqpoly(mda_vals)
  # print(paste("Avg ABR Value:", mean(abr_vals)))
  # freqpoly(abr_vals)
  # par(mfrow=c(1,1))
  if(onlyCalcMFP) {
    mfpReturn <- list(mf_prev_vals, mda_vals, abr_vals)
    names(mfpReturn) <- c('mf_prev', 'mda_vals', 'abr_vals')
    return(mfpReturn)
  }

  abr_vs_mf_prev <- ggplot() + geom_boxplot(aes(x=factor(abr_vals), y=mf_prev_vals)) +
    scale_y_continuous(breaks=seq(0, 0.3, 0.05), limits = c(0, 0.3))

  allOutputs <- allOutputs %>% mutate(age_groups = case_when(
                                                age <= 30 ~ ceiling(age/1)*1,
                                                age <= 75 ~ ceiling(age/5)*5,
                                                TRUE ~ 80
                                              ))
  returnVal <- list(allOutputs, mf_prev_vals, abr_vals, mda_vals, abr_vs_mf_prev)
  names(returnVal) <- c("allOutputs", "mf_prev", "abr_vals", "mda_vals", "abr_vs_mf_prev")
  return(returnVal)
}

calcSensSpecSeroPrev <- function(run_seropos_data, sens=1, spec=1, prob=c()) {
  indv <- length(run_seropos_data)
  if(length(prob) < indv) {
    prob <- runif(indv)
  }
  
  if(length(sens) ==0 | is.na(sens)) {
    sens <- 1
  }
  if(length(sens) == 0 | is.na(spec)) {
    spec <- 1
  }
  
  new_seropos_data<-rep(0, indv)
  pos <- which(run_seropos_data==1)
  neg <- which(run_seropos_data==0)

  if(length(pos) > 0) {
    new_seropos_data[pos] <- as.numeric(prob[pos] <= sens)
  }
  if(length(neg) > 0) {
    new_seropos_data[neg] <- as.numeric(prob[neg] > spec)
  }
  return(new_seropos_data)
}

summarizeSimulationDataHelper <- function(data, sensSpec, sensAgeGroup=5) {
  data$probs <- runif(dim(data)[1])
  if(is.data.frame(sensSpec)) {
    data <- data %>% dplyr::group_by(run_num, age_groups) %>%
      #dplyr::summarise(
      mutate(
        ov16_pos=calcSensSpecSeroPrev(ov16_pos, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs),
        
        ov16_pos_l3=calcSensSpecSeroPrev(ov16_pos_l3, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs),
        
        ov16_pos_l4=calcSensSpecSeroPrev(ov16_pos_l4, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs),
        
        ov16_pos_mating_no_mf=calcSensSpecSeroPrev(ov16_pos_mating_no_mf, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs),
        
        ov16_pos_mating_detectable_mf=calcSensSpecSeroPrev(ov16_pos_mating_detectable_mf, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs),
        
        ov16_pos_mating_any_mf=calcSensSpecSeroPrev(ov16_pos_mating_any_mf, sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'sens'][1], sensSpec[(sensSpec$age_group %in% age_groups) | (sensSpec$age_group %in% (round(age_groups[1]/sensAgeGroup)*sensAgeGroup)), 'spec'][1], probs)
      ) %>% ungroup() %>% as.data.frame()
  } else {
    sens=sensSpec[1]; spec=sensSpec[2]
    if(sens != 1 | spec != 1) {
      data <- data %>% group_by(run_num) %>%
        #summarise(
        mutate(
          ov16_pos=calcSensSpecSeroPrev(ov16_pos, sens, spec, probs),
          ov16_pos_l3=calcSensSpecSeroPrev(ov16_pos_l3, sens, spec, probs),
          ov16_pos_l4=calcSensSpecSeroPrev(ov16_pos_l4, sens, spec, probs),
          ov16_pos_mating_no_mf=calcSensSpecSeroPrev(ov16_pos_mating_no_mf, sens, spec, probs),
          ov16_pos_mating_detectable_mf=calcSensSpecSeroPrev(ov16_pos_mating_detectable_mf, sens, spec, probs),
          ov16_pos_mating_any_mf=calcSensSpecSeroPrev(ov16_pos_mating_any_mf, sens, spec, probs)
        ) %>% ungroup() %>% as.data.frame()
    }
  }
  return(data)
}

summarizeSimulationData <- function(data, sensSpec=c(1,1), groupBySex=TRUE, sensAgeGroup=5) {
  df <- data
  hypothesisNames <- list("Any Worm", "L3 Exposure", "L4-L5 moult", "Mating Worm with any MF", "Mating Worm with detectable MF", "Mating worm")
  groupByCols1 <- c("run_num", "age_groups")
  groupByCols2 <- c("age_groups", "Hypothesis")
  hypNamesLoc <- 3:8
  if(groupBySex) {
    groupByCols1 <- c("run_num", "age_groups", "sex")
    groupByCols2 <- c("age_groups", "sex", "Hypothesis")
    hypNamesLoc <- 4:9
  }
  
  df <- summarizeSimulationDataHelper(df, sensSpec, sensAgeGroup)
  
  df <- df %>%
    dplyr::group_by(!!!syms(groupByCols1)) %>%
    dplyr::summarise(ov16_any_worm_prev=mean(ov16_pos),
                     ov16_l3_prev=mean(ov16_pos_l3),
                     ov16_l4_prev=mean(ov16_pos_l4),
                     ov16_mating_no_mf_prev=mean(ov16_pos_mating_no_mf),
                     ov16_mating_detectable_mf_prev=mean(ov16_pos_mating_detectable_mf),
                     ov16_mating_any_mf_prev=mean(ov16_pos_mating_any_mf),
                     mf_prev=mean(mf_prev), .groups="drop") %>% as.data.frame()
  colnames(df)[all_of(hypNamesLoc)] <- hypothesisNames
  df <- df %>%
    as.data.frame() %>% pivot_longer(cols=all_of(hypNamesLoc), names_to="Hypothesis", values_to = "ov16_prev")

  df <- df %>% dplyr::group_by(!!!syms(groupByCols2)) %>%
    dplyr::summarise(ov16_prev=mean(ov16_prev), mf_prev=mean(mf_prev), .groups="drop") %>% as.data.frame() %>%
    mutate(
      mf_prev = case_when(
        age_groups == 0 & mf_prev > 0 ~ 0,
        TRUE ~ mf_prev
      )
    )

  return(df)
}
```

### Setup and Explore Data

#### ABR vs MFP

```{r calc_mfp, timeit=TRUE}
getRangeOfABR <- function(data, target_mfp, extra=0.002, raw_data=data.frame(), kval="") {
  bin_size <- 500
  if(target_mfp > 0.8) {
    bin_size <- 500
  }
  raw_data <- as.data.frame(raw_data)
  data <- data %>% filter(mfp <= target_mfp + 0.01 + extra & mfp >= target_mfp - extra)
  min_max_data <- c(min(data$abr), max(data$abr))
  raw_data <- raw_data %>% filter(mf_prev >= target_mfp & mf_prev < target_mfp + 0.01)
  print(min_max_data)
  plot <- NA
  if(length(raw_data) > 0) {
    min_val <- floor(min(raw_data$abr_vals)/(bin_size))*(bin_size)
    max_val <- ceiling(max(raw_data$abr_vals)/(bin_size))*(bin_size)
    plot <- ggplot() +
      geom_histogram(aes(x=abr_vals), color='darkblue', fill="lightblue", binwidth=bin_size, boundary = 0, closed="left", data=raw_data) +
      scale_x_continuous(breaks=seq(min_val, max_val, bin_size*2), limits=c(min_val, max_val)) + ylab('Count') + ggtitle(paste('Distribution for', kval, 'of ABR for an MFP of ', target_mfp*100,"%"))
  }
  return_val <- list(min_max_data, plot)
  return(return_val)
}

tmpmfpvals <- data.frame(abr_vals=c(), mf_prev=c())

for(mfp in c(70, 75, 85)) {
  fileNameMFP <- paste("togo_mfp_tuning_k3_", mfp,"_final", sep="")
  target_mfp_str <- strsplit(fileNameMFP, "_")[[1]][5]
  target_mfp <- as.numeric(target_mfp_str)/100
  kval <- strsplit(fileNameMFP, "_")[[1]][4]
  tmp <- processRCSFiles(paste(fileNameMFP,"/",sep=""), verbose=FALSE, onlyCalcMFP=TRUE)
  tmpDf <- data.frame(abr_vals=tmp$abr_vals, mf_prev=tmp$mf_prev)
  tmpmfpvals <- rbind(tmpmfpvals, tmpDf)
}

custom_sample <- function(data) {
  sample_size <- min(nrow(data), 100)
  return(data %>% sample_n(size = sample_size, replace = FALSE))
}

tmpmfpvals_2 <- tmpmfpvals %>% dplyr::mutate(
  abr_vals_2 = case_when(
    abr_vals <= 10000 ~ round(abr_vals/100)*100,
    TRUE ~ round(abr_vals/500)*500,
  )
)  %>% dplyr::group_by(abr_vals_2) %>% group_map(~ custom_sample(.), .keep=TRUE) %>% bind_rows()
tmpmfpvals_2

ggplot() + geom_histogram(aes(x=tmpmfpvals_2$abr_vals), binwidth = 250) +
  scale_y_continuous(breaks = seq(0, 500, 100))

for(mfp in c(70, 75, 85)) {
  target_mfp_str = paste(mfp, "", sep="")
  target_mfp = mfp / 100
  
  summarized_abr_mfp <- data.frame(abr=tmpmfpvals$abr_vals, mfp=tmpmfpvals$mf_prev) %>% group_by(abr) %>% summarise(mfp=mean(mfp), num=count(abr)) %>% as.data.frame()
  print(summarized_abr_mfp)

  ggplot() + geom_line(aes(x=summarized_abr_mfp$abr, summarized_abr_mfp$mfp)) +
  xlab("ABR") + ylab("MFP") + scale_y_continuous(breaks=seq(target_mfp - 0.005, target_mfp + 0.015, 0.005)) + scale_x_continuous(breaks=seq(0, 50000, 500))

  range_return <- getRangeOfABR(summarized_abr_mfp, target_mfp, raw_data=tmpmfpvals_2, kval=kval)
  print(paste("Min, Max:", range_return[1]))
  print(range_return[2])
  ggsave(paste("images/", "abr_dist_", kval, "_", target_mfp_str, ".png", sep=""), range_return[[2]], width=5000, height = 4000, units="px", dpi=600)
}

# summarized_abr_mfp <- data.frame(abr=tmpmfpvals$abr_vals, mfp=tmpmfpvals$mf_prev) %>% group_by(abr) %>% summarise(mfp=mean(mfp), num=count(abr)) %>% as.data.frame()
# print(summarized_abr_mfp)
# 
# ggplot() + geom_line(aes(x=summarized_abr_mfp$abr, summarized_abr_mfp$mfp)) +
#   xlab("ABR") + ylab("MFP") + scale_y_continuous(breaks=seq(target_mfp - 0.005, target_mfp + 0.015, 0.005)) + scale_x_continuous(breaks=seq(0, 50000, 500))
# 
# range_return <- getRangeOfABR(summarized_abr_mfp, target_mfp, raw_data=tmpmfpvals, kval=kval)
# print(paste("Min, Max:", range_return[1]))
# range_return[2]
# ggsave(paste("images/", "abr_dist_", kval, "_", target_mfp_str, ".png", sep=""), range_return[[2]], width=5000, height = 4000, units="px", dpi=600)


# ggplot() + geom_freqpoly(aes(x=tmpmfpvals$mf_prev)) + geom_vline(aes(xintercept=0.055, color="Actual Data Mean")) +
#   xlim(c(0, 0.15)) + geom_vline(aes(xintercept=mean(tmpmfpvals$mf_prev), color="Simulation Mean")) + scale_color_manual(values=c("Simulation Mean"="green", "Actual Data Mean"="red"))

```
#### RDT Simulations

```{r init_sim_data_rdt, timeit=TRUE}
simulateRDT=FALSE
if(simulateRDT) {
  # 4 = rdt dataset (7.7% mfp), 6 = elisa dataset (5.5% mfp), both k=0.2
  # ov16_gabon_k_3_mfp_7
  simulatedGabonData_rdt <- processRCSFiles("ov16_gabon_seroreversion_k_2/", verbose=FALSE)
  
  simulatedGabonData_rdt$abr_vs_mf_prev
  
  data.frame(a=simulatedGabonData_rdt$abr_vals, b=simulatedGabonData_rdt$mf_prev) %>% group_by(a) %>% summarise(mean(b), n(), .groups="drop")
  
  summarizeSimulatedGabon_rdt <- simulatedGabonData_rdt$allOutputs
  
  simulation_summary_rdt <- summarizeSimulationData(summarizeSimulatedGabon_rdt, groupBySex=FALSE)
  sex_split_simulation_summary_rdt <- summarizeSimulationData(summarizeSimulatedGabon_rdt)
  
  simulatedGabonData_rdt_k2 <- processRCSFiles("ov16_gabon_4/", verbose=FALSE)
  
  summarizeSimulatedGabon_rdt_k2 <- simulatedGabonData_rdt_k2$allOutputs
  
  simulation_summary_rdt_k2 <- summarizeSimulationData(summarizeSimulatedGabon_rdt_k2, groupBySex=FALSE)
  sex_split_simulation_summary_rdt_k2 <- summarizeSimulationData(summarizeSimulatedGabon_rdt_k2)
}

```
#### ELISA Simulations

```{r init_sim_data_elisa, timeit=TRUE}
# 4 = rdt dataset (7.7% mfp), 6 = elisa dataset (5.5% mfp), both k=0.2
# ov16_gabon_k_3_mfp_5
simulatedGabonData_elisa <- processRCSFiles("ov16_gabon_k_2_mounted_response_hyp_mfp_5_5/", verbose=FALSE)

simulatedGabonData_elisa$abr_vs_mf_prev

data.frame(a=simulatedGabonData_elisa$abr_vals, b=simulatedGabonData_elisa$mf_prev) %>% group_by(a) %>% summarise(mean(b), n(), .groups="drop")

summarizeSimulatedGabon_elisa <- simulatedGabonData_elisa$allOutputs

simulation_summary_elisa <- summarizeSimulationData(summarizeSimulatedGabon_elisa, groupBySex=FALSE)

#ov16_gabon_6/

# ov16_gabon_seroreversion_3_k_2 seroreversion just trigger
simulatedGabonData_elisa_k2 <- processRCSFiles("ov16_gabon_seroreversion_k_2_everything_gone/", verbose=FALSE)

summarizeSimulatedGabon_elisa_k2 <- simulatedGabonData_elisa_k2$allOutputs

simulation_summary_elisa_k2 <- summarizeSimulationData(summarizeSimulatedGabon_elisa_k2, groupBySex=FALSE)

simulatedGabonData_elisa_100_mount <- processRCSFiles("ov16_gabon_mfp_5_mounted_response_hyp/", verbose=FALSE)

summarizeSimulatedGabon_elisa_100_mount <- simulatedGabonData_elisa_100_mount$allOutputs

simulation_summary_elisa_100_mount <- summarizeSimulationData(summarizeSimulatedGabon_elisa_100_mount, groupBySex=FALSE)


```

## Actual Data

```{r basic_read_functions, timeit=TRUE}
readGabonData <- function() {
  fileName <- "../Ov16 Data/MW_ML_GAB_data.csv"
  data <- read.csv(fileName, check.names = FALSE)
  data <- data[,1:(length(data)-16)]
  cols_to_keep <- c(2, 8, 9, 10, 14, 16, 17, 20, 21, 33, 34)
  data <- data[,cols_to_keep]
  data <- data %>% filter(Country == "Gabon") %>% mutate(
    ov16_seropos = case_when(
      get("Ov16 result") == 1 ~ 1,
      is.na(get("Ov16 result")) ~ 0, # ~ NA,
      TRUE ~ 0
      ),
    mf_pos = ifelse(Oncho_MF_mean_by_snip > 0, 1, 0),
    sex = case_when(
      get("Sex (1=M, 2=F)") == 1 ~ 'Male',
      get("Sex (1=M, 2=F)") == 2 ~'Female',
      TRUE ~ as.character(NA)),
    age_groups = case_when(
      Age <= 30 ~ round(Age/5)*5,
      Age <= 75 ~ round(Age/5)*5,
      TRUE ~ 80
    )
  ) %>% filter(!is.na(mf_pos)) #filter(!is.na(ov16_seropos))

  print(paste("Total Individuals:", length(unique(data$IndividualNo))))
  print(paste("Male to Female Ratio:", mean(((data[,'Sex (1=M, 2=F)']-2)*-1))))
  print(paste("Overall Gabon MF Prevalence:", mean(data$mf_pos)))
  print(paste("Overall Gabon Ov16 SeroPrevalence:", mean(data$ov16_seropos)))

  returnVal <- list(data, mean(data$mf_pos))
  names(returnVal) <- c("data", "mf_prev")
  return(returnVal)
}

readGabonMultiCountryVillageGroupedData <- function() {
  fileName <- "../Ov16 Data/Ov16_Gabon_all_results_by_village.csv"
  data <- read.csv(fileName)
  df <- data.frame(mf_pos=data$MF.Positive, mf_neg=data$MF.Negative, rdt_pos=data$Ov16.RDT.Positive, total_ind=data$Total, ov_pos_mf_pos=data$Ov16.Pos..MF.Pos, ov_neg_mf_neg=data$Ov16.Neg..MF.neg)
  total_data <- df %>% summarise(across(1:4, sum))
  print(paste("Total Individuals:", total_data$total_ind))
  print(paste("Total Mf Pos:", total_data$mf_pos))
  print(paste("Total Ov16 Pos:", total_data$rdt_pos))
  print(paste("Total MFP:", total_data$mf_pos/total_data$total_ind))
  print(paste("Total Ov16 Prev:", total_data$rdt_pos/total_data$total_ind))
  return(df)
}

readGabonDataRDTElisa <- function() {
  fileName <- "../Ov16 Data/Ov16 Gabon ELISA.csv"
  data <- read.csv(fileName) %>% select(1:14) %>% drop_na()
  colnames(data) <- c('id', 'ov16_status_rdt', 'mf_status', 'sample_id', 'inferred_conc', 'region', 'district_name', 'village_name', 'ov16_elisa_plate_num', 'sample_id_ind_id_mismatch', 'ov16_result_elisa', 'ov16_status_elisa', 'age', 'age_group_orig')
  # view duplicate individual id vals, remove them as we don't know which one is correct
  dupIds <- as.numeric(names(which(table(data$id) > 1)))
  data[data$id %in% dupIds,]
  data <- data %>% filter(!(id %in% dupIds)) %>% mutate(
    age_groups = case_when(
      age <= 30 ~ round(age/5)*5,
      age <= 75 ~ round(age/5)*5,
      TRUE ~ 80
    ),
    ov16_status_elisa = case_when(
      ov16_result_elisa == 'Invalid' ~ as.numeric(NaN),
      TRUE ~ as.numeric(ov16_status_elisa)
    )
  ) %>% drop_na()
  
  mf_ci <- wilson.ci(sum(data$mf_status), length(data$mf_status), conf.level=0.95)
  ov16_ci <- wilson.ci(sum(data$ov16_status_elisa), length(data$ov16_status_elisa), conf.level=0.95)
  print(paste("Total Individuals:", length(unique(data$id))))
  print(paste("Overall Gabon MF Prevalence:", mean(data$mf_status), ". 95% Wilson CI: ", mf_ci[1], mf_ci[2]))
  print(paste("Overall Gabon Ov16 ELISA SeroPrevalence:", mean(data$ov16_status_elisa, na.rm=TRUE), ". 95% Wilson CI: ", ov16_ci[1], ov16_ci[2]))
  print(paste("Overall Gabon Ov16 RDT SeroPrevalence:", mean(data$ov16_status_rdt)))

  return(data)
}

processActualGabonData <- function(data, justRDT=TRUE, useSex=TRUE) {
  if(justRDT) {
    groupByCols <- c('age_groups')
    if(useSex) {
      groupByCols <- c('age_groups', 'sex')
    }
    data <- data %>% group_by(!!!syms(groupByCols)) %>% summarise(
      ov16_prev = mean(ov16_seropos),
      mf_prev = mean(mf_pos),
      ov16_wilson_lb = wilson.ci(sum(ov16_seropos), n(), conf.level=0.95)[1],
      ov16_wilson_ub = wilson.ci(sum(ov16_seropos), n(), conf.level=0.95)[2],
      mf_wilson_lb = wilson.ci(sum(mf_pos), n(), conf.level=0.95)[1],
      mf_wilson_ub = wilson.ci(sum(mf_pos), n(), conf.level=0.95)[2],
      .groups="drop"
    ) %>% as.data.frame() %>% drop_na()
    # fit <- lm(ov16_prev ~ log(age_groups+1), data=data)
    # data[, c('yhat', 'lb', 'ub')] <- predict(fit, list(age_groups=data$age_groups), interval='prediction')
    # ggplot() + geom_point(aes(x=age_groups, y=ov16_prev), color="red", data=summarize_gabon_data_2) +
    #   geom_line(aes(x=age_groups, y=ov16_prev), color="red", data=summarize_gabon_data_2) +
    #   geom_line(aes(x=age_groups, y=yhat), data=summarize_gabon_data_2)
  } else {
    data <- data %>% group_by(age_groups) %>% summarise(
      ov16_prev_rdt = mean(ov16_status_rdt),
      ov16_prev_elisa = mean(ov16_status_elisa, na.rm=TRUE),
      mf_prev = mean(mf_status),
      ov16_wilson_lb = wilson.ci(sum(ov16_status_elisa), n(), conf.level=0.95)[1],
      ov16_wilson_ub = wilson.ci(sum(ov16_status_elisa), n(), conf.level=0.95)[2],
      mf_wilson_lb = wilson.ci(sum(mf_status), n(), conf.level=0.95)[1],
      mf_wilson_ub = wilson.ci(sum(mf_status), n(), conf.level=0.95)[2],
      .groups="drop"
    ) %>% as.data.frame()

    # fit <- lm(ov16_prev_rdt ~ log(age_groups+1), data=data)
    # data[, c('yhat_rdt', 'lb_rdt', 'ub_rdt')] <- predict(fit, list(age_groups=data$age_groups), interval='prediction')
    # 
    # fit <- lm(ov16_prev_elisa ~ log(age_groups+1), data=data)
    # data[, c('yhat_elisa', 'lb_elisa', 'ub_elisa')] <- predict(fit, list(age_groups=data$age_groups), interval='prediction')

  }
  data[data$age_groups == 0, c('mf_wilson_lb', 'mf_wilson_ub', 'ov16_wilson_lb', 'ov16_wilson_ub')] <- 0

  return(data)
}
```

### Setup and Explore Data

```{r init_act_data, timeit=TRUE}
print("Multicountry RDT Data")
gabon_multiple_country_rdt <- readGabonData()
print("")
print("Gabon ELISA+RDT Data")
gabon_rdt_elisa <- readGabonDataRDTElisa()
print("")
print("Gabon RDT Village Data")
gabon_village_data <- readGabonMultiCountryVillageGroupedData()

if(simulateRDT) {
  summarize_gabon_multicountry_data_sex <- processActualGabonData(gabon_multiple_country_rdt$data)

  summarize_gabon__multicountrydata_noSex <- processActualGabonData(gabon_multiple_country_rdt$data, useSex = FALSE)
}

summarized_gabon_rdt_elisa <- processActualGabonData(gabon_rdt_elisa, justRDT=FALSE)
```

Based on the above result, we can say that the Multicountry data is RDT Data, as it matches in MF prevalence and OV16 seroprevalence exactly with the Village grouped RDT data. Additionally, it is only of by 7 individuals


## Sens/Spec

### RDT
```{r rdt_sens, timeit=TRUE}
# assuming skin snip result is the truth
# both arrays are in format 0 = negative, 1 = positive
sensSpecCalculator <- function(ov16_test_data, mf_skin_snip_data, ageGroups=c()) {
  if(length(ageGroups) > 1) {
    print("Age Split Sens and Spec")
    df <- data.frame(ov16=ov16_test_data,mf=mf_skin_snip_data, age_group=ageGroups)
    df <- df %>% group_by(age_group) %>% summarize(sens_spec=as.data.frame(sensSpecCalculator(ov16, mf)))
    df <- df %>% tidyr::unpack(cols=sens_spec) %>% as.data.frame() %>% mutate(
      sens=ifelse(is.nan(sens), 1, sens),
      spec=ifelse(is.nan(spec), 1, spec)
    )
    return(df)
  } else {
    m <- matrix(nrow=2, ncol=2)
    same_as_mf <- which(ov16_test_data==mf_skin_snip_data)
    m[1,1] <- sum(ov16_test_data[same_as_mf] == 1)
    m[1,2] <- sum(ov16_test_data[-same_as_mf] == 1)
    m[2,1] <- sum(ov16_test_data[-same_as_mf] == 1)
    m[2,2] <- sum(ov16_test_data[same_as_mf] == 0)
    sens <- m[1,1] / (m[1,1] + m[2,1])
    spec <- m[2,2] / (m[1,2] + m[2,2])
    print(paste("Sensitivity:", sens, "\nSpecificity:", spec))
    return(list(sens=sens,spec=spec))
  }
}



readGabonMultiCountryVillageGroupedDataSensSpec <- function(data) {
  df <- data %>% summarise(across(1:6, sum))
  sens <- df$ov_pos_mf_pos / df$mf_pos
  spec <- df$ov_neg_mf_neg / df$mf_neg
  print(paste("Sensitivity:", sens, "\nSpecificity:", spec))
}

if(simulateRDT) {
  sensAgeGroup <- 5

  age_groups_rdt_sens_spec <- gabon_multiple_country_rdt$data %>% mutate(Age=case_when(
        Age <= 30 ~ round(Age/sensAgeGroup)*sensAgeGroup,
        Age <= 80 ~ round(Age/sensAgeGroup)*sensAgeGroup,
        TRUE ~ 80
      )) %>% select(Age) %>% as.list()
  gabon_rdt_sens_spec <- sensSpecCalculator(gabon_multiple_country_rdt$data$ov16_seropos, gabon_multiple_country_rdt$data$mf_pos, unlist(age_groups_rdt_sens_spec))
    
}

readGabonMultiCountryVillageGroupedDataSensSpec(gabon_village_data)
```
### Adjusting Simulation Data
Sensitivity and Specificity data for ELISA pulled from https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6169192/ 
```{r summarize_data, timeit=TRUE}

elisa_sens_spec_vec <- c(0.43, 0.9998)
#sex_split_simulation_summary_sens_spec_elisa <- summarizeSimulationData(summarizeSimulatedGabon, elisa_sens_spec_vec)

simulation_summary_sens_spec_elisa <- summarizeSimulationData(summarizeSimulatedGabon_elisa, elisa_sens_spec_vec, groupBySex=FALSE)

simulation_summary_sens_spec_elisa_k2 <- summarizeSimulationData(summarizeSimulatedGabon_elisa_k2, elisa_sens_spec_vec, groupBySex=FALSE)

simulation_summary_sens_spec_elisa_100_mount <- summarizeSimulationData(summarizeSimulatedGabon_elisa_100_mount, elisa_sens_spec_vec, groupBySex=FALSE)

if(simulateRDT) {
  #rdt_sens_spec_vec <- as.vector(unlist(gabon_rdt_sens_spec))
  sex_split_simulation_summary_sens_spec_rdt <- summarizeSimulationData(summarizeSimulatedGabon_rdt, gabon_rdt_sens_spec, sensAgeGroup=sensAgeGroup)

  simulation_summary_sens_spec_rdt <- summarizeSimulationData(summarizeSimulatedGabon_rdt, gabon_rdt_sens_spec, groupBySex=FALSE, sensAgeGroup=sensAgeGroup)

  sex_split_simulation_summary_sens_spec_rdt_k2 <- summarizeSimulationData(summarizeSimulatedGabon_rdt_k2, gabon_rdt_sens_spec, sensAgeGroup=sensAgeGroup)

  simulation_summary_sens_spec_rdt_k2 <- summarizeSimulationData(summarizeSimulatedGabon_rdt_k2, gabon_rdt_sens_spec, groupBySex=FALSE, sensAgeGroup=sensAgeGroup)
}
```

## Plots

```{r plot_function}
makePlots <- function(df1, df2, df3, groupBySex='', useYhat=FALSE, type='', compValLabel="", compVal1="", compVal2="", df4, df5, filterHypotheses=0) {
  plotPreFix <- ifelse(type=='', "Gabon RDT Dataset -", paste("Gabon", type, 'Dataset -'))
  plotPostfix <- ifelse(groupBySex=='', '', paste('for ', groupBySex, 's', sep=""))
  type <- ifelse(type=='', type, paste('_', type, sep=""))
  plotLineTypes <- c("solid", "dashed", "dashed", "dashed", "dotted", "dotted", "dotted")
  
  if(filterHypotheses > 0) {
    if(filterHypotheses == 1) {
      df2 <- df2 %>% filter(grepl("Mating", Hypothesis))
      df3 <- df3 %>% filter(grepl("Mating", Hypothesis))
      if(compVal2 != "") {
        df4 <- df4 %>% filter(grepl("Mating", Hypothesis))
        df5 <- df5 %>% filter(grepl("Mating", Hypothesis))
      }
    }
    if(filterHypotheses == 2) {
      df2 <- df2 %>% filter(!grepl("Mating", Hypothesis))
      df3 <- df3 %>% filter(!grepl("Mating", Hypothesis))
      if(compVal2 != "") {
        df4 <- df4 %>% filter(!grepl("Mating", Hypothesis))
        df5 <- df5 %>% filter(!grepl("Mating", Hypothesis))
      }
    }
    plotLineTypes <- c("solid", "dashed", "dotted", "dotted", "dotted", "dotted", "dotted")
  }
  
  plot1 <- ggplot() + geom_point(aes(x=age_groups, y=mf_prev*100, color="Actual Data"), data=df1) +
    geom_errorbar(aes(x=age_groups, ymin=mf_wilson_lb*100, ymax=mf_wilson_ub*100, color="Actual Data"), width=0.2, data=df1) +
    geom_line(aes(x=age_groups, y=mf_prev*100, color="Simulation", linetype=compVal1), data=df2) +
    geom_line(aes(x=age_groups, y=mf_prev*100, color="Simulation", linetype=compVal1), data=df3) + 
    scale_color_manual(name="Type", values=c("black", "red")) +
    xlab("Age") +
    ylab("Microfilarial Prevalence (%)") +
    scale_linetype(guide="none") +
    ggtitle(paste(plotPreFix, ' MF Prevalence By Age ', plotPostfix, sep=""))
  
  if(compVal2 != "") {
    plot1 <- plot1 + geom_line(aes(x=age_groups, y=mf_prev*100, color="Simulation", linetype=compVal2), data=df4) +
      scale_linetype_manual(compValLabel, values=c("solid", "dashed"))
  }
    
  if(groupBySex != '') {
    plot1 <- ggplot() + geom_point(aes(x=age_groups, y=mf_prev*100, color="Female"), data=df1[df1$sex=='Female',]) +
      geom_errorbar(aes(x=age_groups, ymin=mf_wilson_lb*100, ymax=mf_wilson_ub*100, color="Female"), width=0.2, data=df1[df1$sex=='Female',]) +
      
      geom_point(aes(x=age_groups+0.5, y=mf_prev*100, color="Male"), data=df1[df1$sex=='Male',]) +
      geom_errorbar(aes(x=age_groups+0.5, ymin=mf_wilson_lb*100, ymax=mf_wilson_ub*100, color="Male"), width=0.2, data=df1[df1$sex=='Male',]) +
      
      geom_line(aes(x=age_groups, y=mf_prev*100, color=sex, linetype=compVal1), data=df2) +
      geom_line(aes(x=age_groups, y=mf_prev*100, color=sex, linetype=compVal1), data=df3) +
      scale_color_manual(name="Type", values=c("black", "red")) +
      scale_linetype(guide="none") +
      xlab("Age") +
      ylab("Microfilarial Prevalence (%)") +
      ggtitle(paste(plotPreFix, ' MF Prevalence By Age and Sex', sep=""))
    
    if(compVal2 != "") {
      plot1 <- plot1 + 
        geom_line(aes(x=age_groups, y=mf_prev*100, color=sex, linetype=compVal2), data=df4) +
        scale_linetype_manual(compValLabel, labels=c(compVal1, compVal2), values=c("solid", "dashed"))
    }
    
    df1 <- df1 %>% filter(sex==groupBySex)
    df2 <- df2 %>% filter(sex==groupBySex)
    df3 <- df3 %>% filter(sex==groupBySex)
    if(compVal2 != "") {
      df4 <- df4 %>% filter(sex==groupBySex)
      df5 <- df5 %>% filter(sex==groupBySex)
    }
  }
  
  
  plot2 <- ggplot()
  plot3 <- ggplot()
  ov16_var <- paste('ov16_prev', type, sep="")
  
  plot2 <- plot2 + geom_point(aes(x=age_groups, y=get(ov16_var)*100, color="Actual Data", linetype="Actual Data"), data=df1) +
    geom_errorbar(aes(x=age_groups, ymin=ov16_wilson_lb*100, ymax=ov16_wilson_ub*100), width=0.2, colour="black", data=df1)
  plot3 <- plot3 + geom_point(aes(x=age_groups, y=get(ov16_var)*100, color="Actual Data", linetype="Actual Data"), data=df1) +
    geom_errorbar(aes(x=age_groups, ymin=ov16_wilson_lb*100, ymax=ov16_wilson_ub*100), width=0.2, colour="black", data=df1)

  
  plot2 <- plot2 +
    geom_line(aes(x=age_groups, y=ov16_prev*100, color=Hypothesis, linetype=Hypothesis, alpha=1), linewidth=1.1, data=df2) +
    scale_color_manual(name="Hypotheses", values=c("black", "red", "green", "blue", "red", "green", "blue")) +
    #scale_linetype_manual(name="Hypotheses", values=c("solid", "dashed", "dashed", "dashed", "dotted", "dotted", "dotted")) +
    scale_linetype_manual(name="Hypotheses", values=plotLineTypes) +
    ggtitle(paste(plotPreFix, "Simulated Data 100% Sens and Spec", plotPostfix)) +
    xlab("Age") +
    ylab("Ov16 Seroprevalence (%)") +
    scale_alpha(guide="none")
  
  if(compVal2 != "") {
      plot2 <- plot2 + 
        geom_line(aes(x=age_groups, y=ov16_prev*100, color=Hypothesis, linetype=Hypothesis, alpha=0.5), linewidth=1.1, data=df4) +
        scale_alpha(compValLabel, labels=c(compVal2, compVal1), breaks=c(0.5, 0.9), range=c(0.3, 1))
  }

  plot3_label_helper <- ifelse(type=='elisa', '43% Sensitivity and 99.98% Specificity', 'Sensitivity and Specificity') 
  plot3 <- plot3 +
    geom_line(aes(x=age_groups, y=ov16_prev*100, color=Hypothesis, linetype=Hypothesis, alpha=1), linewidth=1.1, data=df3) +
    scale_color_manual(name="Hypotheses", values=c("black", "red", "green", "blue", "red", "green", "blue")) +
    #scale_linetype_manual(name="Hypotheses", values=c("solid", "dashed", "dashed", "dashed", "dotted", "dotted", "dotted")) +
    scale_linetype_manual(name="Hypotheses", values=plotLineTypes) +
    ggtitle(paste(plotPreFix, "Simulated Data Adjusted for", plot3_label_helper, plotPostfix)) +
    xlab("Age") +
    ylab("Ov16 Seroprevalence (%)") +
    scale_alpha(guide="none")
  
  if(compVal2 != "") {
      plot3 <- plot3 + 
        geom_line(aes(x=age_groups, y=ov16_prev*100, color=Hypothesis, linetype=Hypothesis, alpha=0.5), linewidth=1.1, data=df5) +
        scale_alpha(compValLabel, labels=c(compVal2, compVal1), breaks=c(0.5, 0.9), range=c(0.3, 1))
  }

  returnVals <- list(plot1, plot2, plot3)
  names(returnVals) <- list("mf", "full", "edited")
  return(returnVals)
}

savePlots <- function(make_plots_return, prefix="") {
  i<-1
  for(val in make_plots_return) {
    name <- paste("images/", prefix, "_", names(make_plots_return)[i], ".png", sep="")
    ggsave(name, val, width=5000, height = 4000, units="px", dpi=600)
    i <- i+1
  }
}
```

### Make Plots

```{r make_plots, timeit=TRUE}
if(simulateRDT) {
  p_males <- makePlots(summarize_gabon_multicountry_data_sex, sex_split_simulation_summary_rdt, sex_split_simulation_summary_sens_spec_rdt, groupBySex='Male', filterHypotheses=1)
  p_males

  p_females <- makePlots(summarize_gabon_multicountry_data_sex, sex_split_simulation_summary_rdt, sex_split_simulation_summary_sens_spec_rdt,
                       groupBySex='Female', filterHypotheses=1)
  p_females
  
  p_tot <- makePlots(summarize_gabon__multicountrydata_noSex, simulation_summary_rdt, simulation_summary_sens_spec_rdt, filterHypotheses=1)
  p_tot
  
  p_males_k <- makePlots(summarize_gabon_multicountry_data_sex, sex_split_simulation_summary_rdt, sex_split_simulation_summary_sens_spec_rdt, groupBySex='Male', compValLabel="kE Value", compVal1="0.3", compVal2="0.2", df4=sex_split_simulation_summary_rdt_k2, df5=sex_split_simulation_summary_sens_spec_rdt_k2, filterHypotheses=1)
  p_males_k
  
  p_females_k <- makePlots(summarize_gabon_multicountry_data_sex, sex_split_simulation_summary_rdt, sex_split_simulation_summary_sens_spec_rdt, groupBySex='Female', compValLabel="kE Value", compVal1="0.3", compVal2="0.2", df4=sex_split_simulation_summary_rdt_k2, df5=sex_split_simulation_summary_sens_spec_rdt_k2, filterHypotheses=1)
  p_females_k
  
  p_tot_k <- makePlots(summarize_gabon__multicountrydata_noSex, simulation_summary_rdt, simulation_summary_sens_spec_rdt, compValLabel="kE Value", compVal1="0.3", compVal2="0.2", df4=simulation_summary_rdt_k2, df5=simulation_summary_sens_spec_rdt_k2, filterHypotheses=1)
  p_tot_k
}


elisa_plots <- makePlots(summarized_gabon_rdt_elisa, simulation_summary_elisa, simulation_summary_sens_spec_elisa, type='elisa', filterHypotheses=0)
elisa_plots

elisa_plots_k2 <- makePlots(summarized_gabon_rdt_elisa, simulation_summary_elisa_k2, simulation_summary_sens_spec_elisa_k2, type='elisa', filterHypotheses=0)
elisa_plots_k2

elisa_plots_k <- makePlots(summarized_gabon_rdt_elisa, simulation_summary_elisa, simulation_summary_sens_spec_elisa, type='elisa', compValLabel="kE Value", compVal1="0.3", compVal2="0.2", df4=simulation_summary_elisa_k2, df5=simulation_summary_sens_spec_elisa_k2, filterHypotheses=1)
elisa_plots_k

elisa_plots_100_mount <- makePlots(summarized_gabon_rdt_elisa, simulation_summary_elisa, simulation_summary_sens_spec_elisa, type='elisa', compValLabel="% Mounting Antibody Response", compVal1="80", compVal2="100", df4=simulation_summary_elisa_100_mount, df5=simulation_summary_sens_spec_elisa_100_mount, filterHypotheses=1)
elisa_plots_100_mount


# savePlots(p_males, "rdt_male_k3")
# savePlots(p_females, "rdt_female_k3")
# savePlots(p_tot, "rdt_tot_k3")
# savePlots(elisa_plots, "elisa_k3")

if(simulateRDT) {
  savePlots(p_males_k, "rdt_male_k_compare")
  savePlots(p_females_k, "rdt_female_k_compare")
  savePlots(p_tot_k, "rdt_tot_k_compare")  
}

# savePlots(elisa_plots_k2, "elisa_k2_seroreversion")

# savePlots(elisa_plots_k, "elisa_k_compare")
# savePlots(elisa_plots_100_mount, "elisa_mount_compare")

elisa_plots_sero_compare <- makePlots(summarized_gabon_rdt_elisa, simulation_summary_elisa, simulation_summary_sens_spec_elisa, type='elisa', compValLabel="Model Type", compVal1="no seroreversion", compVal2="seroreversion", df4=simulation_summary_elisa_k2, df5=simulation_summary_sens_spec_elisa_k2, filterHypotheses=2)
elisa_plots_sero_compare

savePlots(elisa_plots_sero_compare, "elisa_k2_seroreversion_compare_no_infection_no_mating")
```

